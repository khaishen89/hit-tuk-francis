import React, { useState, useEffect, useCallback, useRef, useMemo } from 'react';
import { createRoot } from 'react-dom/client';

// Constants moved outside to prevent re-renders resetting the timer
const QUOTES = ["Bla Bla Bla!", "Bla bla bla...", "BLA BLA BLA!", "Bla?", "Bla bla bla bla bla!", "Bla bla.", "BLA!"];

const HR_BRIEFINGS = [
  "Management efficiency at 100%! Ee Ling Boss has successfully implemented a 'No Noise' policy for the next 15 minutes.",
  "Senior Tuk Francis has been successfully redirected to the cafeteria. Excellent leadership work, Boss!",
  "Stress levels managed! Ee Ling Boss's decisive action has resulted in a 400% increase in office peace.",
  "HR notes: Ee Ling Boss shows remarkable focus when dealing with 'Bla Bla Bla' interruptions. Promotion pending!",
  "The office is finally quiet. Senior Tuk is currently reconsidering his vocal life choices thanks to your management style.",
  "Direct and effective! Ee Ling Boss has set a new record for silencing office chatter."
];

const TukFrancis = ({ id, visible, onHit, quote }: { id: number, visible: boolean, onHit: (id: number) => void, quote?: string }) => {
  const [isHit, setIsHit] = useState(false);
  
  useEffect(() => { 
    if (!visible) {
      // Small delay before resetting 'hit' state to allow exit animation
      const timer = setTimeout(() => setIsHit(false), 300);
      return () => clearTimeout(timer);
    }
  }, [visible]);

  const handleClick = (e: React.MouseEvent) => {
    e.stopPropagation();
    if (visible && !isHit) {
      setIsHit(true);
      onHit(id);
    }
  };

  return (
    <div className="relative w-full h-40 md:h-56 flex items-end justify-center perspective-1000 overflow-hidden cursor-none" onClick={handleClick}>
      {/* The Hole/Desk */}
      <div className="absolute bottom-4 w-11/12 h-16 bg-amber-100 rounded-t-2xl border-x-4 border-t-4 border-amber-200 z-0 shadow-inner"></div>
      
      {/* Senior Tuk Francis Character */}
      <div className={`relative transition-all duration-300 ease-out transform-gpu z-10 ${visible ? 'translate-y-[-10px] opacity-100' : 'translate-y-full opacity-0 pointer-events-none'} ${isHit ? 'scale-110 -rotate-12 brightness-110' : 'scale-100 hover:scale-105'}`}>
        <div className="relative w-24 h-28 md:w-32 md:h-36 flex flex-col items-center">
          
          {/* Hair Patches */}
          <div className="absolute top-1 w-20 h-10 z-10 flex justify-between px-2">
            <div className="w-5 h-5 bg-gray-200 rounded-full border border-gray-300"></div>
            <div className="w-5 h-5 bg-gray-200 rounded-full border border-gray-300"></div>
          </div>
          
          {/* Face */}
          <div className={`relative w-20 h-22 bg-[#ffdbac] rounded-full shadow-lg border-2 border-[#e1ad8d] flex flex-col items-center justify-center transition-colors ${isHit ? 'bg-red-100' : ''}`}>
            {!isHit && <div className="absolute top-3 w-8 h-1 bg-gray-400/20 rounded-full"></div>}
            
            <div className="relative flex space-x-6 mt-4 z-20">
              {isHit ? (
                <><div className="text-red-600 font-bold text-xl animate-bounce">X</div><div className="text-red-600 font-bold text-xl animate-bounce">X</div></>
              ) : (
                <>
                  <div className="absolute -inset-x-3 -top-1 flex justify-between">
                    <div className="w-8 h-8 rounded-full border-2 border-gray-500 bg-blue-100/30"></div>
                    <div className="w-8 h-8 rounded-full border-2 border-gray-500 bg-blue-100/30"></div>
                  </div>
                  <div className="w-3 h-3 bg-gray-800 rounded-full z-30 animate-pulse"></div>
                  <div className="w-3 h-3 bg-gray-800 rounded-full z-30 animate-pulse"></div>
                </>
              )}
            </div>
            
            <div className="w-3 h-4 bg-[#e1ad8d] rounded-full mt-1 border border-[#c6987a]/50"></div>
            <div className={`mt-2 transition-all ${isHit ? 'w-10 h-4 border-b-4 border-red-500 rounded-full' : 'w-6 h-1 bg-gray-800/20 rounded-full'}`}></div>
          </div>
          
          {/* Business Suit */}
          <div className="w-16 h-12 bg-blue-50 rounded-t-xl border-x-2 border-t-2 border-gray-200 shadow-sm flex justify-around overflow-hidden">
            <div className="w-2 h-full bg-amber-900/70"></div>
            <div className="w-2 h-full bg-amber-900/70"></div>
          </div>
          
          {/* Stars on hit */}
          {isHit && (
            <div className="absolute -top-10 inset-x-0 flex justify-center space-x-2">
              <span className="text-yellow-400 text-xl animate-ping">‚≠ê</span>
              <span className="text-yellow-400 text-sm animate-bounce delay-75">‚≠ê</span>
              <span className="text-yellow-400 text-lg animate-ping delay-150">‚≠ê</span>
            </div>
          )}
        </div>

        {/* Speech Bubble */}
        {visible && !isHit && quote && (
          <div className="absolute -top-24 left-1/2 -translate-x-1/2 w-44 bg-white text-gray-800 text-xs p-3 rounded-2xl border-2 border-indigo-400 shadow-2xl z-20 animate-bounce">
            <span className="font-bold block text-center leading-tight">{quote}</span>
            <div className="absolute bottom-[-10px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-t-[10px] border-t-white"></div>
          </div>
        )}
      </div>

      {/* Desk Nameplate */}
      <div className="absolute bottom-0 w-full h-12 bg-amber-800 rounded-t-lg border-t-4 border-amber-900 shadow-xl z-20 flex items-center justify-center">
        <div className="bg-yellow-50 px-4 py-1 rounded shadow-inner border-2 border-yellow-200 transform -rotate-1">
          <span className="text-[11px] font-black text-amber-900 uppercase tracking-widest">Sr. Tuk Francis</span>
        </div>
      </div>
    </div>
  );
};

const App = () => {
  const [gameState, setGameState] = useState({ 
    score: 0, 
    timeLeft: 30, 
    isGameOver: false, 
    isPlaying: false, 
    stressLevel: 100 
  });
  const [visibleTuks, setVisibleTuks] = useState<boolean[]>(new Array(9).fill(false));
  const [activeQuotes, setActiveQuotes] = useState<(string | undefined)[]>(new Array(9).fill(undefined));
  const [hrReport, setHrReport] = useState('');
  const [mousePos, setMousePos] = useState({ x: 0, y: 0 });
  const [isSwinging, setIsSwinging] = useState(false);

  const timerRef = useRef<number | null>(null);
  const spawnRef = useRef<number | null>(null);

  // Handle Mouse Tracking separately to avoid complex re-renders
  useEffect(() => {
    const handleMouseMove = (e: MouseEvent) => {
      setMousePos({ x: e.clientX, y: e.clientY });
    };
    const handleMouseDown = () => { 
      setIsSwinging(true); 
      setTimeout(() => setIsSwinging(false), 150); 
    };
    window.addEventListener('mousemove', handleMouseMove);
    window.addEventListener('mousedown', handleMouseDown);
    return () => { 
      window.removeEventListener('mousemove', handleMouseMove); 
      window.removeEventListener('mousedown', handleMouseDown); 
    };
  }, []);

  const endGame = useCallback(() => {
    setGameState(prev => ({ ...prev, isPlaying: false, isGameOver: true }));
    if (timerRef.current) clearInterval(timerRef.current);
    if (spawnRef.current) clearInterval(spawnRef.current);
    
    const report = HR_BRIEFINGS[Math.floor(Math.random() * HR_BRIEFINGS.length)];
    setHrReport(report);
  }, []);

  const startGame = useCallback(() => {
    setGameState({ score: 0, timeLeft: 30, isGameOver: false, isPlaying: true, stressLevel: 100 });
    setHrReport('');
    setVisibleTuks(new Array(9).fill(false));
    setActiveQuotes(new Array(9).fill(undefined));
  }, []);

  // Timer Effect - Fixed logic
  useEffect(() => {
    if (gameState.isPlaying) {
      // Clear any existing interval before starting a new one
      if (timerRef.current) clearInterval(timerRef.current);
      
      timerRef.current = window.setInterval(() => {
        setGameState(prev => {
          if (prev.timeLeft <= 1) { 
            // We use a small timeout to let the state settle before ending
            setTimeout(endGame, 10);
            return { ...prev, timeLeft: 0 }; 
          }
          return { ...prev, timeLeft: prev.timeLeft - 1 };
        });
      }, 1000);
    }
    return () => { if (timerRef.current) clearInterval(timerRef.current); };
  }, [gameState.isPlaying, endGame]);

  // Spawning Effect
  useEffect(() => {
    if (gameState.isPlaying) {
      if (spawnRef.current) clearInterval(spawnRef.current);
      
      spawnRef.current = window.setInterval(() => {
        const idx = Math.floor(Math.random() * 9);
        const q = QUOTES[Math.floor(Math.random() * QUOTES.length)];
        
        setVisibleTuks(p => { 
          const n = [...p]; 
          n[idx] = true; 
          return n; 
        });
        setActiveQuotes(p => { 
          const n = [...p]; 
          n[idx] = q; 
          return n; 
        });
        
        // Hide after 1.1s
        setTimeout(() => {
          setVisibleTuks(p => { 
            const n = [...p]; 
            n[idx] = false; 
            return n; 
          });
        }, 1100);
      }, 800);
    }
    return () => { if (spawnRef.current) clearInterval(spawnRef.current); };
  }, [gameState.isPlaying]);

  const handleHit = useCallback((index: number) => {
    setGameState(prev => ({ 
      ...prev, 
      score: prev.score + 10, 
      stressLevel: Math.max(0, prev.stressLevel - 5) 
    }));
  }, []);

  return (
    <div className="min-h-screen bg-[#fff1f2] flex flex-col items-center p-4 md:p-8 cursor-none selection:bg-transparent">
      
      {/* Custom Hammer Cursor */}
      <div id="hammer-cursor" style={{ left: `${mousePos.x}px`, top: `${mousePos.y}px` }}>
        <div className={`hammer-inner ${isSwinging ? 'swing scale-125' : 'scale-100'} transition-transform duration-75`}>
          <div className="relative">
            <div className="w-14 h-10 bg-rose-500 rounded-xl border-4 border-rose-700 shadow-xl flex items-center justify-center">
              <div className="w-full h-1 bg-rose-400 opacity-50 rounded-full mx-2"></div>
            </div>
            <div className="absolute top-10 left-1/2 -translate-x-1/2 w-4 h-12 bg-amber-700 rounded-b-2xl border-x-4 border-b-4 border-amber-900 shadow-md"></div>
          </div>
        </div>
      </div>

      <header className="w-full max-w-4xl flex justify-between items-center mb-6 bg-white p-6 rounded-[2rem] shadow-xl border-b-8 border-indigo-100 z-10 transition-all">
        <div className="flex items-center gap-4">
          <div className="w-14 h-14 bg-gradient-to-br from-pink-400 to-rose-600 rounded-2xl flex items-center justify-center text-3xl shadow-lg animate-bounce">üëë</div>
          <div>
            <h1 className="text-2xl font-black text-indigo-900 tracking-tight">Ee Ling Boss</h1>
            <p className="text-xs text-rose-500 font-bold uppercase tracking-widest">The "Bla Bla" Silencer</p>
          </div>
        </div>
        <div className="flex gap-8">
          <div className="text-center group">
            <span className="text-[10px] uppercase text-gray-400 font-black block tracking-tighter transition-colors group-hover:text-rose-400">Boss Score</span>
            <span className="text-3xl font-black text-rose-600 tabular-nums">{gameState.score}</span>
          </div>
          <div className="text-center group">
            <span className="text-[10px] uppercase text-gray-400 font-black block tracking-tighter transition-colors group-hover:text-indigo-400">Deadline</span>
            <span className="text-3xl font-black text-indigo-700 tabular-nums">{gameState.timeLeft}s</span>
          </div>
        </div>
      </header>

      {/* Stress Meter */}
      <div className="w-full max-w-4xl mb-8 z-10">
        <div className="flex justify-between items-center mb-2 px-1">
          <span className="text-xs font-black text-indigo-900 uppercase flex items-center gap-2">
            <span className="w-2 h-2 rounded-full bg-rose-500 animate-ping"></span> 
            Boss Patience
          </span>
          <span className="text-xs font-black text-indigo-900">{gameState.stressLevel}%</span>
        </div>
        <div className="w-full h-5 bg-white rounded-full p-1 shadow-inner border-2 border-indigo-50 overflow-hidden">
          <div 
            className={`h-full rounded-full transition-all duration-700 ease-out ${
              gameState.stressLevel > 60 ? 'bg-gradient-to-r from-rose-400 to-red-500' : 
              gameState.stressLevel > 20 ? 'bg-gradient-to-r from-orange-400 to-yellow-500' : 
              'bg-gradient-to-r from-emerald-400 to-green-500'
            }`} 
            style={{ width: `${gameState.stressLevel}%` }}
          ></div>
        </div>
      </div>

      {/* Main Game Board */}
      <main className="relative w-full max-w-5xl bg-indigo-50/50 rounded-[3rem] border-8 border-white shadow-2xl p-6 min-h-[550px] flex items-center justify-center z-10 overflow-hidden backdrop-blur-sm">
        {!gameState.isPlaying && !gameState.isGameOver ? (
          <div className="text-center p-10 bg-white/90 rounded-[3rem] shadow-2xl border-4 border-indigo-50 max-w-md animate-in zoom-in duration-500">
            <div className="w-28 h-28 bg-rose-50 rounded-full flex items-center justify-center mx-auto mb-8 shadow-inner border-4 border-white">
              <span className="text-6xl animate-bounce">üëë</span>
            </div>
            <h2 className="text-3xl font-black text-indigo-950 mb-4">Hello, Ee Ling Boss!</h2>
            <p className="text-indigo-900/60 mb-8 text-sm leading-relaxed font-medium">
              Senior Tuk Francis is disrupting the workplace harmony with endless "Bla Bla Bla". 
              Time to apply some high-level management!
            </p>
            <button 
              onClick={startGame} 
              className="group relative px-10 py-4 bg-rose-600 text-white font-black rounded-2xl shadow-[0_8px_0_0_rgba(190,18,60,1)] hover:shadow-[0_4px_0_0_rgba(190,18,60,1)] hover:translate-y-1 active:translate-y-2 active:shadow-none transition-all duration-75 text-lg cursor-none"
            >
              START DIRECTING
            </button>
          </div>
        ) : gameState.isPlaying ? (
          <div className="grid grid-cols-3 gap-8 w-full max-w-4xl">
            {visibleTuks.map((v, i) => (
              <TukFrancis key={i} id={i} visible={v} onHit={handleHit} quote={activeQuotes[i]} />
            ))}
          </div>
        ) : (
          <div className="text-center p-10 bg-white/95 rounded-[3rem] shadow-2xl border-4 border-rose-100 max-w-xl animate-in fade-in zoom-in slide-in-from-bottom-10 duration-500">
            <h2 className="text-4xl font-black text-indigo-950 mb-6 tracking-tight">WORKDAY OVER</h2>
            <div className="relative inline-block mb-10">
              <div className="text-7xl font-black text-rose-600 drop-shadow-lg">{gameState.score}</div>
              <div className="absolute -right-16 -top-4 bg-indigo-600 text-white text-[10px] px-3 py-1 rounded-full font-black rotate-12 uppercase">New Record?</div>
            </div>
            
            <div className="bg-rose-50 p-8 rounded-[2rem] border-2 border-rose-100 text-left mb-8 shadow-inner">
              <h3 className="text-[11px] font-black text-rose-400 uppercase mb-3 tracking-[0.2em]">OFFICIAL HR BRIEFING</h3>
              <p className="italic text-indigo-950 text-lg leading-relaxed font-medium">"{hrReport}"</p>
            </div>
            
            <button 
              onClick={startGame} 
              className="px-10 py-4 bg-indigo-600 text-white font-black rounded-2xl shadow-[0_8px_0_0_rgba(49,46,129,1)] hover:shadow-[0_4px_0_0_rgba(49,46,129,1)] hover:translate-y-1 active:translate-y-2 active:shadow-none transition-all duration-75 text-lg cursor-none"
            >
              MANAGE AGAIN
            </button>
          </div>
        )}
      </main>
      
      <footer className="mt-12 text-indigo-400/50 text-[11px] font-black uppercase tracking-[0.3em] text-center z-10 flex flex-col items-center gap-2">
        <div className="w-10 h-1 bg-indigo-200/30 rounded-full mb-2"></div>
        <p>Boss Management Terminal ‚Ä¢ Build 1.0.42</p>
        <p>HAVE A NICE DAY, EE LING BOSS!</p>
      </footer>
    </div>
  );
};

const container = document.getElementById('root');
if (container) {
  const root = createRoot(container);
  root.render(<App />);
}
